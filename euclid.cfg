[force_move]
enable_force_move: true

[bed_mesh]
horizontal_move_z: 10
mesh_max: 325,325
mesh_min: 25,25

[quad_gantry_level]
horizontal_move_z: 10
retry_tolerance: 0.0075
gantry_corners:
   -60,-10
   410,420
points:
   50,25
   50,275
   300,275
   300,25

[probe]
pin: ^PG11
x_offset: 1.6
y_offset: 23.0
speed: 10.0
samples: 3
samples_result: median
sample_retract_dist: 3
samples_tolerance: 0.050
samples_tolerance_retries: 5

[homing_override]
axes: z
set_position_z: -5
gcode:
  SET_KINEMATIC_POSITION Z=0
  G0 Z15
  G28 X Y               ; home X & Y
  EUCLID_DEPLOY         ; deploy Euclid Probe
  G0 X175 Y175 F3000    ; move to X175 Y175
  G28 Z                 ; home Z
  G0 Z15
  EUCLID_STOW           ; retract Euclid Probe

[gcode_macro EUCLID_DEPLOY]
gcode:
    G90
    error_if_probe_deployed    ; check to make sure that the probe is not already attached
    _EUCLID_DEPLOY

[gcode_macro error_if_probe_deployed]
gcode:
    QUERY_PROBE                 ; check probe status
    do_error_if_probe_deployed  ; logic check to verify probe is not already deployed

[gcode_macro do_error_if_probe_deployed]
gcode:
    {% if not printer.probe.last_query %}
      {action_raise_error("Euclid Probe is already deployed - Remove and Return it to the dock")}
    {% endif %}

[gcode_macro _EUCLID_DEPLOY]
gcode:
    G90
    {% if printer.probe.last_query %} 
      G0 Z15
      G0 X0 Y175 F3000     ;  move the carraige to safe position to move from
      G0 X0 Y350 F3000     ;  move to the side of the dock
      G4 P250              ;  wait 1/4 second 
      G0 X50 Y350 F3000    ;  move sideways over the dock to pick up probe
      M400                 ;  wait for moves to finish
      G4 P250              ;  pause 1/4 sec for detection
      G0 X175 Y175 F3000   ;  move probe to center of bed in ready position 
      G0 Z15
    {% endif %}
    error_if_probe_not_deployed

[gcode_macro error_if_probe_not_deployed]
gcode:
    QUERY_PROBE
    do_error_if_probe_not_deployed

[gcode_macro do_error_if_probe_not_deployed]
gcode:
    {% if printer.probe.last_query %}
      {action_raise_error("Euclid Probe failed to deploy!")}
    {% endif %}

[gcode_macro EUCLID_STOW]
gcode:
    G90
    error_if_probe_not_deployed
    _EUCLID_STOW

[gcode_macro _EUCLID_STOW]
gcode:
  G90
    {% if not printer.probe.last_query %} ; the logic on this needs function check
      G0 Z15
      G0 X175 Y175 F3000            ;  start movements at center of the bed 
      G0 X50 Y350 F3000             ;  move to the re-entry staging position
      G0 X0 Y350 F240               ;  slowly move into dock 
      M400                          ;  wait for moves to finish
      G4 P250                       ;  forced pause here so motion is definite 90 tavel to swipe
      G0 X0 Y300 F6000              ;  quick swipe off
      G0 X175 Y175                  ;  move to center of bed
      G0 Z15
    {% endif %}                     ;  exit the if-then loop. was missing in previous versions
    error_if_probe_deployed         ;  verify that the probe is detached. is corrected error

[gcode_macro BED_MESH_CALIBRATE]
rename_existing: _BED_MESH_CALIBRATE
gcode:
  EUCLID_DEPLOY                  ; deploy Euclid Probe if needed
  _BED_MESH_CALIBRATE            ; check bed level
  EUCLID_STOW                    ; dock Euclid Probe

[gcode_macro QUAD_GANTRY_LEVEL]
rename_existing: _QUAD_GANTRY_LEVEL
gcode:
  EUCLID_DEPLOY                       ; deploy Euclid Probe if needed
  _QUAD_GANTRY_LEVEL                  ; check bed level
  EUCLID_STOW                         ; dock Euclid Probe

[gcode_macro EUCLID_LEVEL_SEQUENCE]
gcode: 
  SET_KINEMATIC_POSITION Z=0
  G0 Z15 F500           ; raise bed to 15
  G28 X Y               ; home Y & Y
  EUCLID_DEPLOY         ; deploy Euclid Probe
  G0 X175 Y175 F3000    ; move to center of be @ X175 Y175
  G28 Z                 ; home Z
  _QUAD_GANTRY_LEVEL
  G28 Z                 ; home Z
  _BED_MESH_CALIBRATE
  G0 Z15 F500           ; raise bed to 15
  EUCLID_STOW           ; retract Euclid Probe
