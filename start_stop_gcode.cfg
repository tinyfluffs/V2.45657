[gcode_macro PRINT_START]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
    {% set CHAMBER_TEMP = params.CHAMBER_TEMP|default(40)|float %}
    {% set EXTRUDER = params.EXTRUDER|default(0)|int %}

    G90 ; use absolute coordinates
    M83 ; extruder relative mode

    ; {% if BED_TEMP|float >= 80 %}
      ; heat soak
      ; M106 S255; Turn on the part cooling fan to max speed
      ; TEMPERATURE_WAIT SENSOR="temperature_sensor Chamber" MINIMUM=32
      ; M106 S0; Turn off the part cooling fan
    ; {% endif %}

    M140 S{BED_TEMP}
    G28
    G90
    TEMPERATURE_WAIT SENSOR="heater_bed" MINIMUM={BED_TEMP}
    ATTACH_PROBE_LOCK
    QUAD_GANTRY_LEVEL
    G28 Z
    G90
    G0 Z20
    G0 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_maximum.y/2} F19500
    BED_MESH_CALIBRATE
    G0 Z20
    DOCK_PROBE_UNLOCK
    G0 X125 Z10 Y{printer.toolhead.axis_maximum.y} F19500
    M104 S{EXTRUDER_TEMP} ; set extruder final temp
    M109 S{EXTRUDER_TEMP} ; wait for extruder final temp

    CLEANNOZZLE
    G28 Z
    DOCK_PROBE_UNLOCK

    CLEANNOZZLE
    CALIBRATE_Z
    SET_GCODE_OFFSET Z_ADJUST=-0.085 MOVE=1
    SET_GCODE_OFFSET Z_ADJUST={params.Z_ADJUST|default(0.0)|float} MOVE=1

    G0 Z20
    DOCK_PROBE_UNLOCK

    _SWIPENOZZLE

    G92 E0
    G1 X0 Y20 Z0.3 F19500.0
    G1 X0 Y200.0 Z0.3 F1500.0 E15
    G92 E0
    G1 Z2.0 F3000

[gcode_macro PRINT_END]
gcode:
    SET_SKEW CLEAR=1

    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 50, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END
    
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament
    
    TURN_OFF_HEATERS

    G91
    G1 Z5 F3000
    
    G90                                      ; absolute positioning
    G1 X{printer.toolhead.axis_maximum.x} Y{printer.toolhead.axis_maximum.y} F19500.0  ; park nozzle at rear
    M107 ; turn off fan
    M84 ; Disable steppers
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END