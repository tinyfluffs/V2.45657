[gcode_macro PRINT_START]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(190)|float %}
    {% set CHAMBER_TEMP = params.CHAMBER_TEMP|default(40)|float %}
    {% set EXTRUDER = params.EXTRUDER|default(0)|int %}

    G90 ; use absolute coordinates
    M83 ; extruder relative mode

    ; Pre-heat
    M104 S180 ; set extruder temp
    M140 S{BED_TEMP}
    TEMPERATURE_WAIT SENSOR="heater_bed" MINIMUM={BED_TEMP}
    M109 S180 ; wait for extruder temp
    TEMPERATURE_WAIT SENSOR="extruder" MINIMUM=180

    #{% if BED_TEMP|float >= 80 %}
    ; heat soak
    ;M106 S255; Turn on the part cooling fan to max speed
    ;BEDFANSZOOMIES
    ;TEMPERATURE_WAIT SENSOR="z_thermal_adjust" MINIMUM=39.5
    ;M106 S0; Turn off the part cooling fan
    ;BEDFANSFAST
    #{% endif %}

    G28 X Y
    ATTACH_PROBE_LOCK
    G28 Z
    QUAD_GANTRY_LEVEL
    BED_MESH_CALIBRATE
    DOCK_PROBE_UNLOCK

    ; purge line heat
    M104 S{EXTRUDER_TEMP} ; set extruder final temp
    M109 S{EXTRUDER_TEMP} ; wait for extruder final temp

    ; ERCF_CHANGE_TOOL_STANDALONE TOOL={EXTRUDER}
    CLEAN_NOZZLE

    ; go to corner
    G1 X5 Y5 F9000
    G1 Z0.15 F1000

    ; ERCF_ENCODER ENABLE=1

    # ; purge line
    G90
    G1 Z0.2 F1000
    G92 E0
    G1 X100 E12.5 F2200
    G1 Y5.15 F1000
    G1 X5 E12.5 F1400
    G1 Z0.2 F1000
    G1 X5 E4 F1000
    G92 E0

    SKEW_PROFILE LOAD=default

[gcode_macro PRINT_END]
gcode:
    SET_SKEW CLEAR=1
    ;{% set UNLOAD = params.UNLOAD_AT_END|default(0)|int %}
    ;ERCF_ENCODER ENABLE=0

    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 50, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END
    
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-5.0 F1800                 ; retract filament
    
    TURN_OFF_HEATERS

    G91
    G1 Z5 F3000
    
    G90                                      ; absolute positioning
    G1 X{printer.toolhead.axis_maximum.x} Y{printer.toolhead.axis_maximum.y} F19500.0  ; park nozzle at rear
    M107 ; turn off fan
    M84 ; Disable steppers

    ;{% if UNLOAD|int == 1 %}
    ;  ERCF_EJECT
    ;{% endif %}
    
    BED_MESH_CLEAR
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END